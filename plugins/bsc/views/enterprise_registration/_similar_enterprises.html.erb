<div id="similar-enterprises" style="display: none;">
  <%= _('Similar enterprises:') %>
  <ul id="create-enterprise-similar-enterprises"></ul>
  <% bsc = BscPlugin::Bsc.find(params[:bsc_id]) %>
  <% query = bsc.enterprises.map(&:id).join(',') %>
  <script type="text/javascript">
    update_enterprises = function(enterprises){
      var association_url = <%= url_for({:controller => 'bsc_plugin_myprofile', :action => 'save_associations', :profile => bsc.identifier}).to_json %>;
      jQuery('#create-enterprise-similar-enterprises').empty();
      jQuery.each(enterprises, function(index, enterprise){
        var id = enterprise[0]
        var name = enterprise[1]
        var query = <%= query.to_json %>;
        if(query)
          query += ',';
        query += id.toString();
        query = '?q='+query;
        var url = association_url + query;
        jQuery('#create-enterprise-similar-enterprises').append(
          '<li>' + name + ' - <a href="' + url +'">' + <%= _('Associate').to_json %> + '</a></li>'
        );
      });
      if (jQuery(enterprises).length > 0)
        jQuery('#similar-enterprises').fadeIn();
      else
        jQuery('#similar-enterprises').fadeOut();
    }
    jQuery('#create_enterprise_name').change(function() {
      var parameters = {};
      if(jQuery('#create_enterprise_name').length)
        parameters.name = jQuery('#create_enterprise_name').val();
      if(jQuery('#create_enterprise_city').length)
        parameters.city = jQuery('#create_enterprise_city').val();

      jQuery.ajax({
        url: <%= url_for({:controller => 'bsc_plugin_myprofile', :action => 'similar_enterprises', :profile => bsc.identifier}).to_json %>,
        dataType: 'json',
        data: parameters,
        success: function(data){ update_enterprises(data); },
        error: function(ajax, stat, errorThrown) {
          alert(stat+': '+errorThrown);
        }
      });
    });
  </script>
</div>
